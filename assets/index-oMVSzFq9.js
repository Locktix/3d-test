import{r as b,j as r,u as ye,H as le,R as q,b as be,i as Ae,e as De,C as Pe,S as Ie,E as je,O as Oe,c as He}from"./react-three-DVy75uqE.js";import{c as Fe,B as Le,R as ke,a as oe}from"./utils-Chpa464g.js";import{m as S,U as ce,H as Ge,Z as Ve,S as We,P as Ke,a as Xe,M as $e,A as qe,X as K}from"./ui-CE_Qmr9o.js";import{c as E,U as L,a1 as T,a7 as Ze,a8 as Qe,a9 as Ye,Y as Je,w as N,s as Z,aa as et,ab as Se,ac as Q,F as tt,ad as G,ae as ie,z as Te,af as we,S as ue,C as st,M as it,i as X,D as $,h as j,ag as rt,a2 as k,ah as v,ai as Ee,E as Me,g as Be,P as nt,aj as at,ak as he,al as de,H as lt,N as ot}from"./three-DCVSJ4Rx.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();const ct={id:"1",name:"Héros",level:1,experience:0,maxExperience:100,health:100,maxHealth:100,mana:50,maxMana:50,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},class:"warrior",inventory:[],equipment:{}},W=Fe((e,t)=>({isLoggedIn:!1,isLoading:!1,player:null,currentZone:"flaris",otherPlayers:[],npcs:[],enemies:[],showInventory:!1,showCharacter:!1,showSkills:!1,showChat:!1,login:(s,i)=>{e({isLoading:!0}),setTimeout(()=>{e({isLoggedIn:!0,isLoading:!1,player:{...ct,name:s}})},1e3)},logout:()=>{e({isLoggedIn:!1,player:null,otherPlayers:[],npcs:[],enemies:[]})},updatePlayer:s=>{const{player:i}=t();i&&e({player:{...i,...s}})},movePlayer:s=>{const{player:i}=t();i&&e({player:{...i,position:s}})},toggleUI:s=>{e(i=>{const n=`show${s.charAt(0).toUpperCase()+s.slice(1)}`;return{[n]:!i[n]}})},addItem:s=>{const{player:i}=t();i&&e({player:{...i,inventory:[...i.inventory,s]}})},removeItem:s=>{const{player:i}=t();i&&e({player:{...i,inventory:i.inventory.filter(n=>n.id!==s)}})},equipItem:(s,i)=>{const{player:n}=t();n&&e({player:{...n,equipment:{...n.equipment,[i]:s}}})}})),ut=()=>{const[e,t]=b.useState(""),[s,i]=b.useState(""),{login:n,isLoading:a}=W(),l=o=>{o.preventDefault(),e.trim()&&s.trim()&&n(e,s)};return r.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-900 via-purple-900 to-blue-900 flex items-center justify-center",children:r.jsxs(S.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.5},className:"bg-black/50 backdrop-blur-sm rounded-2xl p-8 w-full max-w-md",children:[r.jsxs(S.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"text-center mb-8",children:[r.jsx("h1",{className:"text-4xl font-fantasy text-white mb-2",children:"Flyff Universe Clone"}),r.jsx("p",{className:"text-blue-300",children:"Entrez dans le monde de Madrigal"})]}),r.jsxs("form",{onSubmit:l,className:"space-y-6",children:[r.jsxs(S.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.3},children:[r.jsx("label",{className:"block text-white text-sm font-medium mb-2",children:"Nom d'utilisateur"}),r.jsx("input",{type:"text",value:e,onChange:o=>t(o.target.value),className:"w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 transition-colors",placeholder:"Entrez votre nom d'utilisateur",required:!0})]}),r.jsxs(S.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.4},children:[r.jsx("label",{className:"block text-white text-sm font-medium mb-2",children:"Mot de passe"}),r.jsx("input",{type:"password",value:s,onChange:o=>i(o.target.value),className:"w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 transition-colors",placeholder:"Entrez votre mot de passe",required:!0})]}),r.jsx(S.button,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.5},type:"submit",disabled:a,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:a?r.jsxs("div",{className:"flex items-center justify-center",children:[r.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Connexion..."]}):"Se connecter"})]}),r.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},className:"mt-6 text-center",children:r.jsxs("p",{className:"text-gray-400 text-sm",children:["Pas encore de compte ?"," ",r.jsx("button",{className:"text-blue-400 hover:text-blue-300 transition-colors",children:"Créer un compte"})]})})]})})},ht=()=>{const{player:e,toggleUI:t,movePlayer:s}=W();return{handleKeyDown:n=>{if(!e)return;const a=.5,{position:l}=e;switch(n.key.toLowerCase()){case"w":case"arrowup":s({...l,z:l.z-a});break;case"s":case"arrowdown":s({...l,z:l.z+a});break;case"a":case"arrowleft":s({...l,x:l.x-a});break;case"d":case"arrowright":s({...l,x:l.x+a});break;case" ":s({...l,y:l.y+1}),setTimeout(()=>{s({...l,y:l.y})},200);break;case"i":t("inventory");break;case"c":t("character");break;case"k":t("skills");break;case"enter":t("chat");break}}}},dt=({player:e})=>{const t=b.useRef(null),s=b.useRef(null),{handleKeyDown:i}=ht();return ye(n=>{t.current&&s.current&&(s.current.position.set(e.position.x,e.position.y,e.position.z),s.current.rotation.y=e.rotation.y,t.current.position.y=Math.sin(n.clock.elapsedTime*2)*.1)}),b.useEffect(()=>(window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)),[i]),r.jsxs("group",{ref:s,children:[r.jsxs("mesh",{ref:t,castShadow:!0,receiveShadow:!0,children:[r.jsx("capsuleGeometry",{args:[.5,1,4,8]}),r.jsx("meshStandardMaterial",{color:e.class==="warrior"?"#8B4513":e.class==="mage"?"#4B0082":e.class==="archer"?"#228B22":"#2F4F4F"})]}),r.jsxs("mesh",{position:[0,1.2,0],castShadow:!0,children:[r.jsx("sphereGeometry",{args:[.3,16,16]}),r.jsx("meshStandardMaterial",{color:"#FFE4C4"})]}),e.class==="warrior"&&r.jsxs("mesh",{position:[.8,.5,0],rotation:[0,0,Math.PI/4],children:[r.jsx("boxGeometry",{args:[.1,.1,1.5]}),r.jsx("meshStandardMaterial",{color:"#C0C0C0"})]}),e.class==="mage"&&r.jsxs("mesh",{position:[.6,.5,0],children:[r.jsx("cylinderGeometry",{args:[.05,.05,1.2]}),r.jsx("meshStandardMaterial",{color:"#8B4513"})]}),e.class==="archer"&&r.jsxs("mesh",{position:[.8,.5,0],rotation:[0,0,Math.PI/2],children:[r.jsx("torusGeometry",{args:[.4,.05,8,16]}),r.jsx("meshStandardMaterial",{color:"#8B4513"})]}),r.jsx(le,{position:[0,2.5,0],center:!0,children:r.jsxs("div",{className:"bg-black/70 text-white px-2 py-1 rounded text-sm whitespace-nowrap",children:[e.name," Lv.",e.level]})}),r.jsx(le,{position:[0,2.2,0],center:!0,children:r.jsx("div",{className:"w-20 h-2 bg-red-900 rounded-full overflow-hidden",children:r.jsx("div",{className:"health-bar",style:{width:`${e.health/e.maxHealth*100}%`}})})})]})},ft=({zone:e})=>{const t=b.useMemo(()=>{switch(e){case"flaris":return{groundColor:"#90EE90",grassColor:"#228B22",waterColor:"#87CEEB",size:50};case"saintmorning":return{groundColor:"#F4A460",grassColor:"#8FBC8F",waterColor:"#4682B4",size:60};case"darkon":return{groundColor:"#696969",grassColor:"#2F4F4F",waterColor:"#191970",size:70};default:return{groundColor:"#90EE90",grassColor:"#228B22",waterColor:"#87CEEB",size:50}}},[e]);return r.jsxs("group",{children:[r.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-.5,0],receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[t.size,t.size]}),r.jsx("meshStandardMaterial",{color:t.groundColor})]}),Array.from({length:100}).map((s,i)=>r.jsxs("mesh",{position:[(Math.random()-.5)*t.size,0,(Math.random()-.5)*t.size],rotation:[0,Math.random()*Math.PI*2,0],children:[r.jsx("cylinderGeometry",{args:[.1,.1,.5]}),r.jsx("meshStandardMaterial",{color:t.grassColor})]},i)),Array.from({length:20}).map((s,i)=>r.jsxs("group",{position:[(Math.random()-.5)*t.size*.8,0,(Math.random()-.5)*t.size*.8],children:[r.jsxs("mesh",{castShadow:!0,children:[r.jsx("cylinderGeometry",{args:[.3,.4,3]}),r.jsx("meshStandardMaterial",{color:"#8B4513"})]}),r.jsxs("mesh",{position:[0,2.5,0],castShadow:!0,children:[r.jsx("sphereGeometry",{args:[1.5,8,8]}),r.jsx("meshStandardMaterial",{color:"#228B22"})]})]},`tree-${i}`)),Array.from({length:15}).map((s,i)=>r.jsxs("mesh",{position:[(Math.random()-.5)*t.size*.9,0,(Math.random()-.5)*t.size*.9],rotation:[Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI],castShadow:!0,children:[r.jsx("dodecahedronGeometry",{args:[.5+Math.random()*.5]}),r.jsx("meshStandardMaterial",{color:"#696969"})]},`rock-${i}`)),e==="flaris"&&r.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-.3,0],children:[r.jsx("planeGeometry",{args:[20,20]}),r.jsx("meshStandardMaterial",{color:t.waterColor,transparent:!0,opacity:.6})]}),e==="darkon"&&r.jsx("group",{children:Array.from({length:5}).map((s,i)=>r.jsxs("mesh",{position:[(Math.random()-.5)*t.size,0,(Math.random()-.5)*t.size],castShadow:!0,children:[r.jsx("coneGeometry",{args:[3+Math.random()*2,8+Math.random()*4]}),r.jsx("meshStandardMaterial",{color:"#708090"})]},`mountain-${i}`))})]})},pt=()=>{var l,o,c;const{player:e,showInventory:t,showCharacter:s,showSkills:i,showChat:n,toggleUI:a}=W();return e?r.jsxs("div",{className:"game-ui",children:[r.jsxs("div",{className:"absolute top-4 left-4 right-4 flex justify-between items-start",children:[r.jsxs("div",{className:"bg-black/70 backdrop-blur-sm rounded-lg p-4 text-white",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.jsx(ce,{size:16}),r.jsx("span",{className:"font-medium",children:e.name}),r.jsxs("span",{className:"text-yellow-400",children:["Lv.",e.level]})]}),r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx(Ge,{size:14,className:"text-red-400"}),r.jsx("div",{className:"w-32 h-2 bg-red-900 rounded-full overflow-hidden",children:r.jsx(S.div,{className:"health-bar",initial:{width:0},animate:{width:`${e.health/e.maxHealth*100}%`},transition:{duration:.3}})}),r.jsxs("span",{className:"text-xs",children:[e.health,"/",e.maxHealth]})]}),r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx(Ve,{size:14,className:"text-blue-400"}),r.jsx("div",{className:"w-32 h-2 bg-blue-900 rounded-full overflow-hidden",children:r.jsx(S.div,{className:"mana-bar",initial:{width:0},animate:{width:`${e.mana/e.maxMana*100}%`},transition:{duration:.3}})}),r.jsxs("span",{className:"text-xs",children:[e.mana,"/",e.maxMana]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(We,{size:14,className:"text-green-400"}),r.jsx("div",{className:"w-32 h-1 bg-green-900 rounded-full overflow-hidden",children:r.jsx(S.div,{className:"exp-bar",initial:{width:0},animate:{width:`${e.experience/e.maxExperience*100}%`},transition:{duration:.3}})}),r.jsxs("span",{className:"text-xs",children:[e.experience,"/",e.maxExperience]})]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>a("character"),className:"bg-black/70 hover:bg-black/80 text-white p-3 rounded-lg transition-colors",children:r.jsx(ce,{size:20})}),r.jsx("button",{onClick:()=>a("inventory"),className:"bg-black/70 hover:bg-black/80 text-white p-3 rounded-lg transition-colors",children:r.jsx(Ke,{size:20})}),r.jsx("button",{onClick:()=>a("skills"),className:"bg-black/70 hover:bg-black/80 text-white p-3 rounded-lg transition-colors",children:r.jsx(Xe,{size:20})}),r.jsx("button",{onClick:()=>a("chat"),className:"bg-black/70 hover:bg-black/80 text-white p-3 rounded-lg transition-colors",children:r.jsx($e,{size:20})})]})]}),r.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2",children:r.jsx("div",{className:"bg-black/70 backdrop-blur-sm rounded-lg p-2 flex gap-2",children:[1,2,3,4,5,6,7,8].map(u=>r.jsx("div",{className:"w-12 h-12 bg-gray-800 border border-gray-600 rounded-lg flex items-center justify-center text-white text-sm hover:border-gray-400 transition-colors cursor-pointer",children:u},u))})}),r.jsxs(qe,{children:[t&&r.jsxs(S.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"absolute inset-4 bg-black/80 backdrop-blur-sm rounded-lg p-6",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{className:"text-2xl font-fantasy text-white",children:"Inventaire"}),r.jsx("button",{onClick:()=>a("inventory"),className:"text-white hover:text-gray-300",children:r.jsx(K,{size:24})})]}),r.jsx("div",{className:"grid grid-cols-8 gap-2",children:Array.from({length:40}).map((u,h)=>r.jsx("div",{className:"inventory-slot w-12 h-12 rounded-lg flex items-center justify-center",children:e.inventory[h]&&r.jsx("div",{className:"text-xs text-white text-center",children:e.inventory[h].name})},h))})]}),s&&r.jsxs(S.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"absolute inset-4 bg-black/80 backdrop-blur-sm rounded-lg p-6",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{className:"text-2xl font-fantasy text-white",children:"Personnage"}),r.jsx("button",{onClick:()=>a("character"),className:"text-white hover:text-gray-300",children:r.jsx(K,{size:24})})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[r.jsxs("div",{className:"text-white",children:[r.jsx("h3",{className:"text-lg font-medium mb-2",children:"Informations"}),r.jsxs("p",{children:["Nom: ",e.name]}),r.jsxs("p",{children:["Classe: ",e.class]}),r.jsxs("p",{children:["Niveau: ",e.level]}),r.jsxs("p",{children:["Expérience: ",e.experience,"/",e.maxExperience]})]}),r.jsxs("div",{className:"text-white",children:[r.jsx("h3",{className:"text-lg font-medium mb-2",children:"Équipement"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Arme:"}),r.jsx("span",{children:((l=e.equipment.weapon)==null?void 0:l.name)||"Aucune"})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Armure:"}),r.jsx("span",{children:((o=e.equipment.armor)==null?void 0:o.name)||"Aucune"})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Casque:"}),r.jsx("span",{children:((c=e.equipment.helmet)==null?void 0:c.name)||"Aucun"})]})]})]})]})]}),i&&r.jsxs(S.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"absolute inset-4 bg-black/80 backdrop-blur-sm rounded-lg p-6",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{className:"text-2xl font-fantasy text-white",children:"Compétences"}),r.jsx("button",{onClick:()=>a("skills"),className:"text-white hover:text-gray-300",children:r.jsx(K,{size:24})})]}),r.jsx("div",{className:"grid grid-cols-3 gap-4",children:["Attaque de base","Compétence spéciale","Sort de guérison","Bouclier","Charge","Explosion"].map((u,h)=>r.jsxs("div",{className:"skill-button text-center py-4",children:[r.jsx("div",{className:"text-lg mb-2",children:"⚔️"}),r.jsx("div",{className:"text-sm",children:u}),r.jsx("div",{className:"text-xs text-gray-400 mt-1",children:"Niveau 1"})]},h))})]}),n&&r.jsxs(S.div,{initial:{opacity:0,y:100},animate:{opacity:1,y:0},exit:{opacity:0,y:100},className:"absolute bottom-20 left-4 right-4 bg-black/80 backdrop-blur-sm rounded-lg p-4",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsx("h3",{className:"text-white font-medium",children:"Chat"}),r.jsx("button",{onClick:()=>a("chat"),className:"text-white hover:text-gray-300",children:r.jsx(K,{size:16})})]}),r.jsxs("div",{className:"h-32 bg-gray-900 rounded p-2 mb-2 overflow-y-auto text-white text-sm",children:[r.jsx("div",{className:"text-green-400",children:"[Système] Bienvenue dans Flyff Universe Clone!"}),r.jsx("div",{className:"text-blue-400",children:"[Général] Joueur123: Salut tout le monde!"}),r.jsx("div",{className:"text-yellow-400",children:"[Commerce] Vendeur456: Vente d'équipement rare"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",placeholder:"Tapez votre message...",className:"flex-1 bg-gray-800 text-white px-3 py-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500"}),r.jsx("button",{className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded",children:"Envoyer"})]})]})]})]}):null};/**
 * postprocessing v6.37.6 build Fri Jul 04 2025
 * https://github.com/pmndrs/postprocessing
 * Copyright 2015-2025 Raoul van Rüschen
 * @license Zlib
 */var J=1/1e3,vt=1e3,mt=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(e){typeof document<"u"&&document.hidden!==void 0&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=e)}get delta(){return this._delta*J}get fixedDelta(){return this._fixedDelta*J}set fixedDelta(e){this._fixedDelta=e*vt}get elapsed(){return this._elapsed*J}update(e){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(e!==void 0?e:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(e){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},gt=(()=>{const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]),s=new at;return s.setAttribute("position",new he(e,3)),s.setAttribute("uv",new he(t,2)),s})(),M=class te{static get fullscreenGeometry(){return gt}constructor(t="Pass",s=new ue,i=new st){this.name=t,this.renderer=null,this.scene=s,this.camera=i,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(t){if(this.rtt===t){const s=this.fullscreenMaterial;s!==null&&(s.needsUpdate=!0),this.rtt=!t}}set mainScene(t){}set mainCamera(t){}setRenderer(t){this.renderer=t}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(t){let s=this.screen;s!==null?s.material=t:(s=new it(te.fullscreenGeometry,t),s.frustumCulled=!1,this.scene===null&&(this.scene=new ue),this.scene.add(s),this.screen=s)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(t){this.fullscreenMaterial=t}getDepthTexture(){return null}setDepthTexture(t,s=G){}render(t,s,i,n,a){throw new Error("Render method not implemented!")}setSize(t,s){}initialize(t,s,i){}dispose(){for(const t of Object.keys(this)){const s=this[t];(s instanceof N||s instanceof Ee||s instanceof Me||s instanceof te)&&this[t].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},xt=class extends M{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,s,i,n){const a=e.state.buffers.stencil;a.setLocked(!1),a.setTest(!1)}},yt=`#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
uniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;
#include <colorspace_fragment>
#include <dithering_fragment>
}`,Ue="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",Re=class extends j{constructor(){super({name:"CopyMaterial",uniforms:{inputBuffer:new v(null),opacity:new v(1)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:yt,vertexShader:Ue})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}getOpacity(e){return this.uniforms.opacity.value}setOpacity(e){this.uniforms.opacity.value=e}},bt=class extends M{constructor(e,t=!0){super("CopyPass"),this.fullscreenMaterial=new Re,this.needsSwap=!1,this.renderTarget=e,e===void 0&&(this.renderTarget=new N(1,1,{minFilter:Z,magFilter:Z,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(e){this.autoResize=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(e){this.autoResize=e}render(e,t,s,i,n){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.autoResize&&this.renderTarget.setSize(e,t)}initialize(e,t,s){s!==void 0&&(this.renderTarget.texture.type=s,s!==L?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":e!==null&&e.outputColorSpace===T&&(this.renderTarget.texture.colorSpace=T))}},fe=new Se,_e=class extends M{constructor(e=!0,t=!0,s=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=s,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(e,t,s){this.color=e,this.depth=t,this.stencil=s}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(e){this.overrideClearColor=e}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(e){this.overrideClearAlpha=e}render(e,t,s,i,n){const a=this.overrideClearColor,l=this.overrideClearAlpha,o=e.getClearAlpha(),c=a!==null,u=l>=0;c?(e.getClearColor(fe),e.setClearColor(a,u?l:o)):u&&e.setClearAlpha(l),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),c?e.setClearColor(fe,o):u&&e.setClearAlpha(o)}},St=class extends M{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new _e(!1,!1,!0),this.inverse=!1}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get inverted(){return this.inverse}set inverted(e){this.inverse=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(e){this.inverted=e}render(e,t,s,i,n){const a=e.getContext(),l=e.state.buffers,o=this.scene,c=this.camera,u=this.clearPass,h=this.inverted?0:1,f=1-h;l.color.setMask(!1),l.depth.setMask(!1),l.color.setLocked(!0),l.depth.setLocked(!0),l.stencil.setTest(!0),l.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),l.stencil.setFunc(a.ALWAYS,h,4294967295),l.stencil.setClear(f),l.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?u.render(e,null):(u.render(e,t),u.render(e,s))),this.renderToScreen?(e.setRenderTarget(null),e.render(o,c)):(e.setRenderTarget(t),e.render(o,c),e.setRenderTarget(s),e.render(o,c)),l.color.setLocked(!1),l.depth.setLocked(!1),l.stencil.setLocked(!1),l.stencil.setFunc(a.EQUAL,1,4294967295),l.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),l.stencil.setLocked(!0)}},Tt=class{constructor(t=null,{depthBuffer:s=!0,stencilBuffer:i=!1,multisampling:n=0,frameBufferType:a}={}){this.renderer=null,this.inputBuffer=this.createBuffer(s,i,a,n),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new bt,this.depthTexture=null,this.passes=[],this.timer=new mt,this.autoRenderToScreen=!0,this.setRenderer(t)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(t){const s=this.inputBuffer,i=this.multisampling;i>0&&t>0?(this.inputBuffer.samples=t,this.outputBuffer.samples=t,this.inputBuffer.dispose(),this.outputBuffer.dispose()):i!==t&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(s.depthBuffer,s.stencilBuffer,s.texture.type,t),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(t){if(this.renderer=t,t!==null){const s=t.getSize(new E),i=t.getContext().getContextAttributes().alpha,n=this.inputBuffer.texture.type;n===L&&t.outputColorSpace===T&&(this.inputBuffer.texture.colorSpace=T,this.outputBuffer.texture.colorSpace=T,this.inputBuffer.dispose(),this.outputBuffer.dispose()),t.autoClear=!1,this.setSize(s.width,s.height);for(const a of this.passes)a.initialize(t,i,n)}}replaceRenderer(t,s=!0){const i=this.renderer,n=i.domElement.parentNode;return this.setRenderer(t),s&&n!==null&&(n.removeChild(i.domElement),n.appendChild(t.domElement)),i}createDepthTexture(){const t=this.depthTexture=new Ze;return this.inputBuffer.depthTexture=t,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(t.format=Qe,t.type=Ye):t.type=Je,t}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const t of this.passes)t.setDepthTexture(null)}}createBuffer(t,s,i,n){const a=this.renderer,l=a===null?new E:a.getDrawingBufferSize(new E),o={minFilter:Z,magFilter:Z,stencilBuffer:s,depthBuffer:t,type:i},c=new N(l.width,l.height,o);return n>0&&(c.ignoreDepthForMultisampleCopy=!1,c.samples=n),i===L&&a!==null&&a.outputColorSpace===T&&(c.texture.colorSpace=T),c.texture.name="EffectComposer.Buffer",c.texture.generateMipmaps=!1,c}setMainScene(t){for(const s of this.passes)s.mainScene=t}setMainCamera(t){for(const s of this.passes)s.mainCamera=t}addPass(t,s){const i=this.passes,n=this.renderer,a=n.getDrawingBufferSize(new E),l=n.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(t.setRenderer(n),t.setSize(a.width,a.height),t.initialize(n,l,o),this.autoRenderToScreen&&(i.length>0&&(i[i.length-1].renderToScreen=!1),t.renderToScreen&&(this.autoRenderToScreen=!1)),s!==void 0?i.splice(s,0,t):i.push(t),this.autoRenderToScreen&&(i[i.length-1].renderToScreen=!0),t.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const c=this.createDepthTexture();for(t of i)t.setDepthTexture(c)}else t.setDepthTexture(this.depthTexture)}removePass(t){const s=this.passes,i=s.indexOf(t);if(i!==-1&&s.splice(i,1).length>0){if(this.depthTexture!==null){const l=(c,u)=>c||u.needsDepthTexture;s.reduce(l,!1)||(t.getDepthTexture()===this.depthTexture&&t.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&i===s.length&&(t.renderToScreen=!1,s.length>0&&(s[s.length-1].renderToScreen=!0))}}removeAllPasses(){const t=this.passes;this.deleteDepthTexture(),t.length>0&&(this.autoRenderToScreen&&(t[t.length-1].renderToScreen=!1),this.passes=[])}render(t){const s=this.renderer,i=this.copyPass;let n=this.inputBuffer,a=this.outputBuffer,l=!1,o,c,u;t===void 0&&(this.timer.update(),t=this.timer.getDelta());for(const h of this.passes)h.enabled&&(h.render(s,n,a,t,l),h.needsSwap&&(l&&(i.renderToScreen=h.renderToScreen,o=s.getContext(),c=s.state.buffers.stencil,c.setFunc(o.NOTEQUAL,1,4294967295),i.render(s,n,a,t,l),c.setFunc(o.EQUAL,1,4294967295)),u=n,n=a,a=u),h instanceof St?l=!0:h instanceof xt&&(l=!1))}setSize(t,s,i){const n=this.renderer,a=n.getSize(new E);(t===void 0||s===void 0)&&(t=a.width,s=a.height),(a.width!==t||a.height!==s)&&n.setSize(t,s,i);const l=n.getDrawingBufferSize(new E);this.inputBuffer.setSize(l.width,l.height),this.outputBuffer.setSize(l.width,l.height);for(const o of this.passes)o.setSize(l.width,l.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const t of this.passes)t.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),M.fullscreenGeometry.dispose()}},D={NONE:0,DEPTH:1,CONVOLUTION:2},p={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},wt=class{constructor(){this.shaderParts=new Map([[p.FRAGMENT_HEAD,null],[p.FRAGMENT_MAIN_UV,null],[p.FRAGMENT_MAIN_IMAGE,null],[p.VERTEX_HEAD,null],[p.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=D.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=Te}},ee=!1,pe=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=t=>{if(t.isMesh){let s;if(t.material.flatShading)switch(t.material.side){case $:s=this.materialsFlatShadedDoubleSide;break;case X:s=this.materialsFlatShadedBackSide;break;default:s=this.materialsFlatShaded;break}else switch(t.material.side){case $:s=this.materialsDoubleSide;break;case X:s=this.materialsBackSide;break;default:s=this.materials;break}this.originalMaterials.set(t,t.material),t.isSkinnedMesh?t.material=s[2]:t.isInstancedMesh?t.material=s[1]:t.material=s[0],++this.meshCount}}}cloneMaterial(e){if(!(e instanceof j))return e.clone();const t=e.uniforms,s=new Map;for(const n in t){const a=t[n].value;a.isRenderTargetTexture&&(t[n].value=null,s.set(n,a))}const i=e.clone();for(const n of s)t[n[0]].value=n[1],i.uniforms[n[0]].value=n[1];return i}setMaterial(e){if(this.disposeMaterials(),this.material=e,e!==null){const t=this.materials=[this.cloneMaterial(e),this.cloneMaterial(e),this.cloneMaterial(e)];for(const s of t)s.uniforms=Object.assign({},e.uniforms),s.side=rt;t[2].skinning=!0,this.materialsBackSide=t.map(s=>{const i=this.cloneMaterial(s);return i.uniforms=Object.assign({},e.uniforms),i.side=X,i}),this.materialsDoubleSide=t.map(s=>{const i=this.cloneMaterial(s);return i.uniforms=Object.assign({},e.uniforms),i.side=$,i}),this.materialsFlatShaded=t.map(s=>{const i=this.cloneMaterial(s);return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i}),this.materialsFlatShadedBackSide=t.map(s=>{const i=this.cloneMaterial(s);return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i.side=X,i}),this.materialsFlatShadedDoubleSide=t.map(s=>{const i=this.cloneMaterial(s);return i.uniforms=Object.assign({},e.uniforms),i.flatShading=!0,i.side=$,i})}}render(e,t,s){const i=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,ee){const n=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,s);for(const a of n)a[0].material=a[1];this.meshCount!==n.size&&n.clear()}else{const n=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,s),t.overrideMaterial=n}e.shadowMap.enabled=i}disposeMaterials(){if(this.material!==null){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return ee}static set workaroundEnabled(e){ee=e}},I=-1,w=class extends ie{constructor(e,t=I,s=I,i=1){super(),this.resizable=e,this.baseSize=new E(1,1),this.preferredSize=new E(t,s),this.target=this.preferredSize,this.s=i,this.effectiveSize=new E,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const e=this.baseSize,t=this.preferredSize,s=this.effectiveSize,i=this.scale;t.width!==I?s.width=t.width:t.height!==I?s.width=Math.round(t.height*(e.width/Math.max(e.height,1))):s.width=Math.round(e.width*i),t.height!==I?s.height=t.height:t.width!==I?s.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1)):s.height=Math.round(e.height*i)}get width(){return this.effectiveSize.width}set width(e){this.preferredWidth=e}get height(){return this.effectiveSize.height}set height(e){this.preferredHeight=e}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(e){this.s!==e&&(this.s=e,this.preferredSize.setScalar(I),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(e){this.scale=e}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(e){this.baseWidth=e}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(e){this.baseHeight=e}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(e){this.preferredWidth=e}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(e){this.preferredHeight=e}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(e){this.s=e.scale,this.baseSize.set(e.baseWidth,e.baseHeight),this.preferredSize.set(e.preferredWidth,e.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return I}},d={ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},Et="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(x.rgb+y.rgb,y.a),opacity);}",Mt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,y.a*opacity);}",Bt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4((x.rgb+y.rgb)*0.5,y.a),opacity);}",Ut="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.xy,xHSL.z));return mix(x,vec4(z,y.a),opacity);}",Rt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 a=x.rgb,b=y.rgb;vec3 z=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/b)),vec3(1.0),step(1.0,a));return mix(x,vec4(z,y.a),opacity);}",_t="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 a=x.rgb,b=y.rgb;vec3 z=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(x,vec4(z,y.a),opacity);}",Ct="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(min(x.rgb,y.rgb),y.a),opacity);}",zt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(abs(x.rgb-y.rgb),y.a),opacity);}",Nt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(x.rgb/max(y.rgb,1e-12),y.a),opacity);}",At="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4((x.rgb+y.rgb-2.0*x.rgb*y.rgb),y.a),opacity);}",Dt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 a=min(x.rgb,1.0);vec3 b=min(y.rgb,1.0);vec3 z=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(x,vec4(z,y.a),opacity);}",Pt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(step(1.0,x.rgb+y.rgb),y.a),opacity);}",It="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.x,xHSL.yz));return mix(x,vec4(z,y.a),opacity);}",jt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(1.0-y.rgb,y.a),opacity);}",Ot="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(y.rgb*(1.0-x.rgb),y.a),opacity);}",Ht="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(max(x.rgb,y.rgb),y.a),opacity);}",Ft="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(clamp(y.rgb+x.rgb-1.0,0.0,1.0),y.a),opacity);}",Lt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(min(x.rgb+y.rgb,1.0),y.a),opacity);}",kt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(clamp(2.0*y.rgb+x.rgb-1.0,0.0,1.0),y.a),opacity);}",Gt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.xy,yHSL.z));return mix(x,vec4(z,y.a),opacity);}",Vt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(x.rgb*y.rgb,y.a),opacity);}",Wt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(1.0-abs(1.0-x.rgb-y.rgb),y.a),opacity);}",Kt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,opacity);}",Xt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 z=mix(2.0*y.rgb*x.rgb,1.0-2.0*(1.0-y.rgb)*(1.0-x.rgb),step(0.5,x.rgb));return mix(x,vec4(z,y.a),opacity);}",$t="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 y2=2.0*y.rgb;vec3 z=mix(mix(y2,x.rgb,step(0.5*x.rgb,y.rgb)),max(y2-1.0,vec3(0.0)),step(x.rgb,y2-1.0));return mix(x,vec4(z,y.a),opacity);}",qt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 z=mix(min(x.rgb*x.rgb/max(1.0-y.rgb,1e-12),1.0),y.rgb,step(1.0,y.rgb));return mix(x,vec4(z,y.a),opacity);}",Zt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.x,yHSL.y,xHSL.z));return mix(x,vec4(z,y.a),opacity);}",Qt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(x.rgb+y.rgb-min(x.rgb*y.rgb,1.0),y.a),opacity);}",Yt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 a=x.rgb;vec3 b=y.rgb;vec3 y2=2.0*b;vec3 w=step(0.5,b);vec3 c=a-(1.0-y2)*a*(1.0-a);vec3 d=mix(a+(y2-1.0)*(sqrt(a)-a),a+(y2-1.0)*a*((16.0*a-12.0)*a+3.0),w*(1.0-step(0.25,a)));vec3 z=mix(c,d,w);return mix(x,vec4(z,y.a),opacity);}",Jt="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y;}",es="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,vec4(max(x.rgb+y.rgb-1.0,0.0),y.a),opacity);}",ts="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 z=mix(max(1.0-min((1.0-x.rgb)/(2.0*y.rgb),1.0),0.0),min(x.rgb/(2.0*(1.0-y.rgb)),1.0),step(0.5,y.rgb));return mix(x,vec4(z,y.a),opacity);}",ss=new Map([[d.ADD,Et],[d.ALPHA,Mt],[d.AVERAGE,Bt],[d.COLOR,Ut],[d.COLOR_BURN,Rt],[d.COLOR_DODGE,_t],[d.DARKEN,Ct],[d.DIFFERENCE,zt],[d.DIVIDE,Nt],[d.DST,null],[d.EXCLUSION,At],[d.HARD_LIGHT,Dt],[d.HARD_MIX,Pt],[d.HUE,It],[d.INVERT,jt],[d.INVERT_RGB,Ot],[d.LIGHTEN,Ht],[d.LINEAR_BURN,Ft],[d.LINEAR_DODGE,Lt],[d.LINEAR_LIGHT,kt],[d.LUMINOSITY,Gt],[d.MULTIPLY,Vt],[d.NEGATION,Wt],[d.NORMAL,Kt],[d.OVERLAY,Xt],[d.PIN_LIGHT,$t],[d.REFLECT,qt],[d.SATURATION,Zt],[d.SCREEN,Qt],[d.SOFT_LIGHT,Yt],[d.SRC,Jt],[d.SUBTRACT,es],[d.VIVID_LIGHT,ts]]),is=class extends ie{constructor(e,t=1){super(),this._blendFunction=e,this.opacity=new v(t)}getOpacity(){return this.opacity.value}setOpacity(e){this.opacity.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e}getShaderCode(){return ss.get(this.blendFunction)}},se=class extends ie{constructor(e,t,{attributes:s=D.NONE,blendFunction:i=d.NORMAL,defines:n=new Map,uniforms:a=new Map,extensions:l=null,vertexShader:o=null}={}){super(),this.name=e,this.renderer=null,this.attributes=s,this.fragmentShader=t,this.vertexShader=o,this.defines=n,this.uniforms=a,this.extensions=l,this.blendMode=new is(i),this.blendMode.addEventListener("change",c=>this.setChanged()),this._inputColorSpace=Te,this._outputColorSpace=we}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}set mainScene(e){}set mainCamera(e){}getName(){return this.name}setRenderer(e){this.renderer=e}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(e,t=G){}update(e,t,s){}setSize(e,t){}initialize(e,t,s){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof N||t instanceof Ee||t instanceof Me||t instanceof M)&&this[e].dispose()}}},re={MEDIUM:2,LARGE:3},rs=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,ns="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",as=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],ls=class extends j{constructor(e=new de){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new v(null),texelSize:new v(new de),scale:new v(1),kernel:new v(0)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:rs,vertexShader:ns}),this.setTexelSize(e.x,e.y),this.kernelSize=re.MEDIUM}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.inputBuffer=e}get kernelSequence(){return as[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}getScale(){return this.uniforms.scale.value}setScale(e){this.uniforms.scale.value=e}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(e){this.uniforms.kernel.value=e}setKernel(e){this.kernel=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t,e*.5,t*.5)}setSize(e,t){const s=1/e,i=1/t;this.uniforms.texelSize.value.set(s,i,s*.5,i*.5)}},os=class extends M{constructor({kernelSize:e=re.MEDIUM,resolutionScale:t=.5,width:s=w.AUTO_SIZE,height:i=w.AUTO_SIZE,resolutionX:n=s,resolutionY:a=i}={}){super("KawaseBlurPass"),this.renderTargetA=new N(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const l=this.resolution=new w(this,n,a,t);l.addEventListener("change",o=>this.setSize(l.baseWidth,l.baseHeight)),this._blurMaterial=new ls,this._blurMaterial.kernelSize=e,this.copyMaterial=new Re}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(e){this._blurMaterial=e}get dithering(){return this.copyMaterial.dithering}set dithering(e){this.copyMaterial.dithering=e}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get scale(){return this.blurMaterial.scale}set scale(e){this.blurMaterial.scale=e}getScale(){return this.blurMaterial.scale}setScale(e){this.blurMaterial.scale=e}getKernelSize(){return this.kernelSize}setKernelSize(e){this.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,s,i,n){const a=this.scene,l=this.camera,o=this.renderTargetA,c=this.renderTargetB,u=this.blurMaterial,h=u.kernelSequence;let f=t;this.fullscreenMaterial=u;for(let y=0,g=h.length;y<g;++y){const C=y&1?c:o;u.kernel=h[y],u.inputBuffer=f.texture,e.setRenderTarget(C),e.render(a,l),f=C}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=f.texture,e.setRenderTarget(this.renderToScreen?null:s),e.render(a,l)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t);const i=s.width,n=s.height;this.renderTargetA.setSize(i,n),this.renderTargetB.setSize(i,n),this.blurMaterial.setSize(e,t)}initialize(e,t,s){s!==void 0&&(this.renderTargetA.texture.type=s,this.renderTargetB.texture.type=s,s!==L?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):e!==null&&e.outputColorSpace===T&&(this.renderTargetA.texture.colorSpace=T,this.renderTargetB.texture.colorSpace=T))}static get AUTO_SIZE(){return w.AUTO_SIZE}},cs=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);l*=low*high;
#elif defined(THRESHOLD)
l=smoothstep(threshold,threshold+smoothing,l)*l;
#endif
#ifdef COLOR
gl_FragColor=vec4(texel.rgb*clamp(l,0.0,1.0),l);
#else
gl_FragColor=vec4(l);
#endif
}`,us=class extends j{constructor(e=!1,t=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:Be.replace(/\D+/g,"")},uniforms:{inputBuffer:new v(null),threshold:new v(0),smoothing:new v(1),range:new v(null)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:cs,vertexShader:Ue}),this.colorOutput=e,this.luminanceRange=t}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.smoothing>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=e}getThreshold(){return this.threshold}setThreshold(e){this.threshold=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.threshold>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=e}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(e){this.smoothing=e}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(e){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(e){return this.colorOutput}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return this.luminanceRange!==null}set useRange(e){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(e){e!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=e,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(e){this.luminanceRange=e}},hs=class extends M{constructor({renderTarget:e,luminanceRange:t,colorOutput:s,resolutionScale:i=1,width:n=w.AUTO_SIZE,height:a=w.AUTO_SIZE,resolutionX:l=n,resolutionY:o=a}={}){super("LuminancePass"),this.fullscreenMaterial=new us(s,t),this.needsSwap=!1,this.renderTarget=e,this.renderTarget===void 0&&(this.renderTarget=new N(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const c=this.resolution=new w(this,l,o,i);c.addEventListener("change",u=>this.setSize(c.baseWidth,c.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(e,t,s,i,n){const a=this.fullscreenMaterial;a.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height)}initialize(e,t,s){s!==void 0&&s!==L&&(this.renderTarget.texture.type=s,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},ds=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,fs="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",ps=class extends j{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new v(null),texelSize:new v(new E)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:ds,vertexShader:fs})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},vs=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,ms="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",gs=class extends j{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new v(null),supportBuffer:new v(null),texelSize:new v(new E),radius:new v(.85)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:vs,vertexShader:ms})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}set supportBuffer(e){this.uniforms.supportBuffer.value=e}get radius(){return this.uniforms.radius.value}set radius(e){this.uniforms.radius.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},xs=class extends M{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new N(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new ps,this.upsamplingMaterial=new gs,this.resolution=new E}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(this.levels!==e){const t=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let s=0;s<e;++s){const i=t.clone();i.texture.name="Downsampling.Mipmap"+s,this.downsamplingMipmaps.push(i)}this.upsamplingMipmaps.push(t);for(let s=1,i=e-1;s<i;++s){const n=t.clone();n.texture.name="Upsampling.Mipmap"+s,this.upsamplingMipmaps.push(n)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}render(e,t,s,i,n){const{scene:a,camera:l}=this,{downsamplingMaterial:o,upsamplingMaterial:c}=this,{downsamplingMipmaps:u,upsamplingMipmaps:h}=this;let f=t;this.fullscreenMaterial=o;for(let y=0,g=u.length;y<g;++y){const C=u[y];o.setSize(f.width,f.height),o.inputBuffer=f.texture,e.setRenderTarget(C),e.render(a,l),f=C}this.fullscreenMaterial=c;for(let y=h.length-1;y>=0;--y){const g=h[y];c.setSize(f.width,f.height),c.inputBuffer=f.texture,c.supportBuffer=u[y].texture,e.setRenderTarget(g),e.render(a,l),f=g}}setSize(e,t){const s=this.resolution;s.set(e,t);let i=s.width,n=s.height;for(let a=0,l=this.downsamplingMipmaps.length;a<l;++a)i=Math.round(i*.5),n=Math.round(n*.5),this.downsamplingMipmaps[a].setSize(i,n),a<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[a].setSize(i,n)}initialize(e,t,s){if(s!==void 0){const i=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const n of i)n.texture.type=s;if(s!==L)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(e!==null&&e.outputColorSpace===T)for(const n of i)n.texture.colorSpace=T}}dispose(){super.dispose();for(const e of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))e.dispose()}},ys=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 texel=texture2D(map,uv);outputColor=vec4(texel.rgb*intensity,max(inputColor.a,texel.a));}`,bs=class extends se{constructor({blendFunction:e=d.SCREEN,luminanceThreshold:t=1,luminanceSmoothing:s=.03,mipmapBlur:i=!0,intensity:n=1,radius:a=.85,levels:l=8,kernelSize:o=re.LARGE,resolutionScale:c=.5,width:u=w.AUTO_SIZE,height:h=w.AUTO_SIZE,resolutionX:f=u,resolutionY:y=h}={}){super("BloomEffect",ys,{blendFunction:e,uniforms:new Map([["map",new v(null)],["intensity",new v(n)]])}),this.renderTarget=new N(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new os({kernelSize:o}),this.luminancePass=new hs({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=s,this.mipmapBlurPass=new xs,this.mipmapBlurPass.enabled=i,this.mipmapBlurPass.radius=a,this.mipmapBlurPass.levels=l,this.uniforms.get("map").value=i?this.mipmapBlurPass.texture:this.renderTarget.texture;const g=this.resolution=new w(this,f,y,c);g.addEventListener("change",C=>this.setSize(g.baseWidth,g.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(e){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getIntensity(){return this.intensity}setIntensity(e){this.intensity=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,s){const i=this.renderTarget,n=this.luminancePass;n.enabled?(n.render(e,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,n.renderTarget):this.blurPass.render(e,n.renderTarget,i)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,t):this.blurPass.render(e,t,i)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height),this.blurPass.resolution.copy(s),this.luminancePass.setSize(e,t),this.mipmapBlurPass.setSize(e,t)}initialize(e,t,s){this.blurPass.initialize(e,t,s),this.luminancePass.initialize(e,t,s),this.mipmapBlurPass.initialize(e,t,s),s!==void 0&&(this.renderTarget.texture.type=s,e!==null&&e.outputColorSpace===T&&(this.renderTarget.texture.colorSpace=T))}},Ce=class extends M{constructor(e,t,s=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new _e,this.overrideMaterialManager=s===null?null:new pe(s),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return e!==null?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;e!==null?t!==null?t.setMaterial(e):this.overrideMaterialManager=new pe(e):t!==null&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(e){this.overrideMaterial=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(e){this.ignoreBackground=e}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(e){this.skipShadowMapUpdate=e}getClearPass(){return this.clearPass}render(e,t,s,i,n){const a=this.scene,l=this.camera,o=this.selection,c=l.layers.mask,u=a.background,h=e.shadowMap.autoUpdate,f=this.renderToScreen?null:t;o!==null&&l.layers.set(o.getLayer()),this.skipShadowMapUpdate&&(e.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(a.background=null),this.clearPass.enabled&&this.clearPass.render(e,t),e.setRenderTarget(f),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(e,a,l):e.render(a,l),l.layers.mask=c,a.background=u,e.shadowMap.autoUpdate=h}},Ss=`#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
#ifdef DOWNSAMPLE_NORMALS
uniform lowp sampler2D normalBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])*0.25;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);
#ifdef DOWNSAMPLE_NORMALS
vec3 n[4];n[0]=texture2D(normalBuffer,vUv0).rgb;n[1]=texture2D(normalBuffer,vUv1).rgb;n[2]=texture2D(normalBuffer,vUv2).rgb;n[3]=texture2D(normalBuffer,vUv3).rgb;
#else
vec3 n[4];n[0]=vec3(0.0);n[1]=vec3(0.0);n[2]=vec3(0.0);n[3]=vec3(0.0);
#endif
gl_FragColor=vec4(n[index],d[index]);}`,Ts="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",ws=class extends j{constructor(){super({name:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new v(null),normalBuffer:new v(null),texelSize:new v(new E)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Ss,vertexShader:Ts})}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=G){this.depthBuffer=e,this.depthPacking=t}set normalBuffer(e){this.uniforms.normalBuffer.value=e,e!==null?this.defines.DOWNSAMPLE_NORMALS="1":delete this.defines.DOWNSAMPLE_NORMALS,this.needsUpdate=!0}setNormalBuffer(e){this.normalBuffer=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},Es=class extends M{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:s=w.AUTO_SIZE,height:i=w.AUTO_SIZE,resolutionX:n=s,resolutionY:a=i}={}){super("DepthDownsamplingPass");const l=new ws;l.normalBuffer=e,this.fullscreenMaterial=l,this.needsDepthTexture=!0,this.needsSwap=!1,this.renderTarget=new N(1,1,{minFilter:Q,magFilter:Q,depthBuffer:!1,type:tt}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1;const o=this.resolution=new w(this,n,a,t);o.addEventListener("change",c=>this.setSize(o.baseWidth,o.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}setDepthTexture(e,t=G){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t}render(e,t,s,i,n){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height),this.fullscreenMaterial.setSize(e,t)}initialize(e,t,s){const i=e.getContext();if(!(i.getExtension("EXT_color_buffer_float")||i.getExtension("EXT_color_buffer_half_float")))throw new Error("Rendering to float texture is not supported.")}},Ms=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,Bs="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",Us=class extends j{constructor(e,t,s,i,n=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:Be.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new v(null),depthBuffer:new v(null),resolution:new v(new E),texelSize:new v(new E),cameraNear:new v(.3),cameraFar:new v(1e3),aspect:new v(1),time:new v(0)},blending:k,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:n}),e&&this.setShaderParts(e),t&&this.setDefines(t),s&&this.setUniforms(s),this.copyCameraSettings(i)}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){this.uniforms.depthBuffer.value=e}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=G){this.depthBuffer=e,this.depthPacking=t}setShaderData(e){this.setShaderParts(e.shaderParts),this.setDefines(e.defines),this.setUniforms(e.uniforms),this.setExtensions(e.extensions)}setShaderParts(e){return this.fragmentShader=Ms.replace(p.FRAGMENT_HEAD,e.get(p.FRAGMENT_HEAD)||"").replace(p.FRAGMENT_MAIN_UV,e.get(p.FRAGMENT_MAIN_UV)||"").replace(p.FRAGMENT_MAIN_IMAGE,e.get(p.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=Bs.replace(p.VERTEX_HEAD,e.get(p.VERTEX_HEAD)||"").replace(p.VERTEX_MAIN_SUPPORT,e.get(p.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(e){this.extensions={};for(const t of e)this.extensions[t]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(e){this.encodeOutput!==e&&(e?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(e){return this.encodeOutput}setOutputEncodingEnabled(e){this.encodeOutput=e}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setDeltaTime(e){this.uniforms.time.value+=e}adoptCameraSettings(e){this.copyCameraSettings(e)}copyCameraSettings(e){e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof nt?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const s=this.uniforms;s.resolution.value.set(e,t),s.texelSize.value.set(1/e,1/t),s.aspect.value=e/t}static get Section(){return p}};function ve(e,t,s){for(const i of t){const n="$1"+e+i.charAt(0).toUpperCase()+i.slice(1),a=new RegExp("([^\\.])(\\b"+i+"\\b)","g");for(const l of s.entries())l[1]!==null&&s.set(l[0],l[1].replace(a,n))}}function Rs(e,t,s){let i=t.getFragmentShader(),n=t.getVertexShader();const a=i!==void 0&&/mainImage/.test(i),l=i!==void 0&&/mainUv/.test(i);if(s.attributes|=t.getAttributes(),i===void 0)throw new Error(`Missing fragment shader (${t.name})`);if(l&&s.attributes&D.CONVOLUTION)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!a&&!l)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const o=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,c=s.shaderParts;let u=c.get(p.FRAGMENT_HEAD)||"",h=c.get(p.FRAGMENT_MAIN_UV)||"",f=c.get(p.FRAGMENT_MAIN_IMAGE)||"",y=c.get(p.VERTEX_HEAD)||"",g=c.get(p.VERTEX_MAIN_SUPPORT)||"";const C=new Set,B=new Set;if(l&&(h+=`	${e}MainUv(UV);
`,s.uvTransformation=!0),n!==null&&/mainSupport/.test(n)){const x=/mainSupport *\([\w\s]*?uv\s*?\)/.test(n);g+=`	${e}MainSupport(`,g+=x?`vUv);
`:`);
`;for(const m of n.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const U of m[1].split(/\s*,\s*/))s.varyings.add(U),C.add(U),B.add(U);for(const m of n.matchAll(o))B.add(m[1])}for(const x of i.matchAll(o))B.add(x[1]);for(const x of t.defines.keys())B.add(x.replace(/\([\w\s,]*\)/g,""));for(const x of t.uniforms.keys())B.add(x);B.delete("while"),B.delete("for"),B.delete("if"),t.uniforms.forEach((x,m)=>s.uniforms.set(e+m.charAt(0).toUpperCase()+m.slice(1),x)),t.defines.forEach((x,m)=>s.defines.set(e+m.charAt(0).toUpperCase()+m.slice(1),x));const O=new Map([["fragment",i],["vertex",n]]);ve(e,B,s.defines),ve(e,B,O),i=O.get("fragment"),n=O.get("vertex");const z=t.blendMode;if(s.blendModes.set(z.blendFunction,z),a){t.inputColorSpace!==null&&t.inputColorSpace!==s.colorSpace&&(f+=t.inputColorSpace===T?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),t.outputColorSpace!==we?s.colorSpace=t.outputColorSpace:t.inputColorSpace!==null&&(s.colorSpace=t.inputColorSpace);const x=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;f+=`${e}MainImage(color0, UV, `,s.attributes&D.DEPTH&&x.test(i)&&(f+="depth, ",s.readDepth=!0),f+=`color1);
	`;const m=e+"BlendOpacity";s.uniforms.set(m,z.opacity),f+=`color0 = blend${z.blendFunction}(color0, color1, ${m});

	`,u+=`uniform float ${m};

`}if(u+=i+`
`,n!==null&&(y+=n+`
`),c.set(p.FRAGMENT_HEAD,u),c.set(p.FRAGMENT_MAIN_UV,h),c.set(p.FRAGMENT_MAIN_IMAGE,f),c.set(p.VERTEX_HEAD,y),c.set(p.VERTEX_MAIN_SUPPORT,g),t.extensions!==null)for(const x of t.extensions)s.extensions.add(x)}}var _s=class extends M{constructor(e,...t){super("EffectPass"),this.fullscreenMaterial=new Us(null,null,null,e),this.listener=s=>this.handleEvent(s),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(e){for(const t of this.effects)t.mainScene=e}set mainCamera(e){this.fullscreenMaterial.copyCameraSettings(e);for(const t of this.effects)t.mainCamera=e}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(e){this.fullscreenMaterial.encodeOutput=e}get dithering(){return this.fullscreenMaterial.dithering}set dithering(e){const t=this.fullscreenMaterial;t.dithering=e,t.needsUpdate=!0}setEffects(e){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=e.sort((t,s)=>s.attributes-t.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const e=new wt;let t=0;for(const l of this.effects)if(l.blendMode.blendFunction===d.DST)e.attributes|=l.getAttributes()&D.DEPTH;else{if(e.attributes&l.getAttributes()&D.CONVOLUTION)throw new Error(`Convolution effects cannot be merged (${l.name})`);Rs("e"+t++,l,e)}let s=e.shaderParts.get(p.FRAGMENT_HEAD),i=e.shaderParts.get(p.FRAGMENT_MAIN_IMAGE),n=e.shaderParts.get(p.FRAGMENT_MAIN_UV);const a=/\bblend\b/g;for(const l of e.blendModes.values())s+=l.getShaderCode().replace(a,`blend${l.blendFunction}`)+`
`;e.attributes&D.DEPTH?(e.readDepth&&(i=`float depth = readDepth(UV);

	`+i),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,e.colorSpace===T&&(i+=`color0 = sRGBToLinear(color0);
	`),e.uvTransformation?(n=`vec2 transformedUv = vUv;
`+n,e.defines.set("UV","transformedUv")):e.defines.set("UV","vUv"),e.shaderParts.set(p.FRAGMENT_HEAD,s),e.shaderParts.set(p.FRAGMENT_MAIN_IMAGE,i),e.shaderParts.set(p.FRAGMENT_MAIN_UV,n);for(const[l,o]of e.shaderParts)o!==null&&e.shaderParts.set(l,o.trim().replace(/^#/,`
#`));this.skipRendering=t===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(e)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(e,t=G){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t;for(const s of this.effects)s.setDepthTexture(e,t)}render(e,t,s,i,n){for(const a of this.effects)a.update(e,t,i);if(!this.skipRendering||this.renderToScreen){const a=this.fullscreenMaterial;a.inputBuffer=t.texture,a.time+=i*this.timeScale,e.setRenderTarget(this.renderToScreen?null:s),e.render(this.scene,this.camera)}}setSize(e,t){this.fullscreenMaterial.setSize(e,t);for(const s of this.effects)s.setSize(e,t)}initialize(e,t,s){this.renderer=e;for(const i of this.effects)i.initialize(e,t,s);this.updateMaterial(),s!==void 0&&s!==L&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const e of this.effects)e.removeEventListener("change",this.listener),e.dispose()}handleEvent(e){switch(e.type){case"change":this.recompile();break}}},Cs=class extends M{constructor(e,t,{renderTarget:s,resolutionScale:i=1,width:n=w.AUTO_SIZE,height:a=w.AUTO_SIZE,resolutionX:l=n,resolutionY:o=a}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new Ce(e,t,new et);const c=this.renderPass;c.ignoreBackground=!0,c.skipShadowMapUpdate=!0;const u=c.getClearPass();u.overrideClearColor=new Se(7829503),u.overrideClearAlpha=1,this.renderTarget=s,this.renderTarget===void 0&&(this.renderTarget=new N(1,1,{minFilter:Q,magFilter:Q}),this.renderTarget.texture.name="NormalPass.Target");const h=this.resolution=new w(this,l,o,i);h.addEventListener("change",f=>this.setSize(h.baseWidth,h.baseHeight))}set mainScene(e){this.renderPass.mainScene=e}set mainCamera(e){this.renderPass.mainCamera=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,s,i,n){const a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a,a)}setSize(e,t){const s=this.resolution;s.setBaseSize(e,t),this.renderTarget.setSize(s.width,s.height)}};const zs=b.createContext(null),me=e=>(e.getAttributes()&D.CONVOLUTION)===D.CONVOLUTION,Ns=q.memo(b.forwardRef(({children:e,camera:t,scene:s,resolutionScale:i,enabled:n=!0,renderPriority:a=1,autoClear:l=!0,depthBuffer:o,enableNormalPass:c,stencilBuffer:u,multisampling:h=8,frameBufferType:f=lt},y)=>{const{gl:g,scene:C,camera:B,size:O}=be(),z=s||C,x=t||B,[m,U,H]=b.useMemo(()=>{const P=Ae(),R=new Tt(g,{depthBuffer:o,stencilBuffer:u,multisampling:h>0&&P?h:0,frameBufferType:f});R.addPass(new Ce(z,x));let A=null,_=null;return c&&(_=new Cs(z,x),_.enabled=!1,R.addPass(_),i!==void 0&&P&&(A=new Es({normalBuffer:_.texture,resolutionScale:i}),A.enabled=!1,R.addPass(A))),[R,_,A]},[x,g,o,u,h,f,z,c,i]);b.useEffect(()=>m==null?void 0:m.setSize(O.width,O.height),[m,O]),ye((P,R)=>{if(n){const A=g.autoClear;g.autoClear=l,u&&!l&&g.clearStencil(),m.render(R),g.autoClear=A}},n?a:0);const ne=b.useRef(null);b.useLayoutEffect(()=>{var P;const R=[],A=(P=ne.current)==null?void 0:P.__r3f;if(A&&m){const _=A.objects;for(let F=0;F<_.length;F++){const V=_[F];if(V instanceof se){const ae=[V];if(!me(V)){let Y=null;for(;(Y=_[F+1])instanceof se&&!me(Y);)ae.push(Y),F++}const Ne=new _s(x,...ae);R.push(Ne)}else V instanceof M&&R.push(V)}for(const F of R)m==null||m.addPass(F);U&&(U.enabled=!0),H&&(H.enabled=!0)}return()=>{for(const _ of R)m==null||m.removePass(_);U&&(U.enabled=!1),H&&(H.enabled=!1)}},[m,e,x,U,H]),b.useEffect(()=>{const P=g.toneMapping;return g.toneMapping=ot,()=>{g.toneMapping=P}},[g]);const ze=b.useMemo(()=>({composer:m,normalPass:U,downSamplingPass:H,resolutionScale:i,camera:x,scene:z}),[m,U,H,i,x,z]);return b.useImperativeHandle(y,()=>m,[m]),r.jsx(zs.Provider,{value:ze,children:r.jsx("group",{ref:ne,children:e})})}));let As=0;const ge=new WeakMap,Ds=(e,t)=>q.forwardRef(function({blendFunction:i=t==null?void 0:t.blendFunction,opacity:n=t==null?void 0:t.opacity,...a},l){let o=ge.get(e);if(!o){const h=`@react-three/postprocessing/${e.name}-${As++}`;De({[h]:e}),ge.set(e,o=h)}const c=be(h=>h.camera),u=q.useMemo(()=>{var h,f;return[...(h=t==null?void 0:t.args)!=null?h:[],...(f=a.args)!=null?f:[{...t,...a}]]},[JSON.stringify(a)]);return r.jsx(o,{camera:c,"blendMode-blendFunction":i,"blendMode-opacity-value":n,...a,ref:l,args:u})}),Ps=Ds(bs,{blendFunction:d.ADD}),xe=()=>{const{player:e,currentZone:t}=W();return e?r.jsxs("div",{className:"w-full h-full relative",children:[r.jsxs(Pe,{camera:{position:[0,5,10],fov:75},shadows:!0,className:"w-full h-full",children:[r.jsxs(b.Suspense,{fallback:null,children:[r.jsx("ambientLight",{intensity:.4}),r.jsx("directionalLight",{position:[10,10,5],intensity:1,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048}),r.jsx(Ie,{sunPosition:[100,20,100]}),r.jsx(je,{preset:"sunset"}),r.jsx(ft,{zone:t}),r.jsx(dt,{player:e}),r.jsx(Ns,{children:r.jsx(Ps,{luminanceThreshold:.5,intensity:.5})})]}),r.jsx(Oe,{target:[e.position.x,e.position.y,e.position.z],maxPolarAngle:Math.PI/2,minDistance:3,maxDistance:20})]}),r.jsx(pt,{})]}):r.jsx("div",{children:"Erreur: Joueur non trouvé"})},Is=()=>r.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-900 flex flex-col items-center justify-center z-50",children:r.jsxs(S.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.5},className:"text-center",children:[r.jsx(S.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0,ease:"linear"},className:"w-16 h-16 border-4 border-white border-t-transparent rounded-full mb-8 mx-auto"}),r.jsx(S.h1,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"text-4xl font-fantasy text-white mb-4",children:"Flyff Universe Clone"}),r.jsx(S.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4},className:"text-xl text-blue-200 mb-8",children:"Chargement en cours..."}),r.jsx(S.div,{initial:{width:0},animate:{width:"100%"},transition:{duration:2,ease:"easeInOut"},className:"h-2 bg-blue-500 rounded-full max-w-md"})]})});function js(){const[e,t]=b.useState(!0),{isLoggedIn:s}=W();return b.useEffect(()=>{const i=setTimeout(()=>{t(!1)},2e3);return()=>clearTimeout(i)},[]),e?r.jsx(Is,{}):r.jsx(Le,{children:r.jsx("div",{className:"App",children:r.jsxs(ke,{children:[r.jsx(oe,{path:"/",element:s?r.jsx(xe,{}):r.jsx(ut,{})}),r.jsx(oe,{path:"/game",element:r.jsx(xe,{})})]})})})}He.createRoot(document.getElementById("root")).render(r.jsx(q.StrictMode,{children:r.jsx(js,{})}));
//# sourceMappingURL=index-oMVSzFq9.js.map
